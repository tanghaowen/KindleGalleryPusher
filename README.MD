KindleGalleryPusherğŸ“·
==========

[demoã¯ã“ã¡ã‚‰](http://gallery.lpanda.net/)

è²´æ–¹ã®å†™çœŸé›†ã‚’ã¿ã‚“ãªã¨ã‚·ã‚§ã‚¢ã—ã¾ã›ã‚“ã‹ï¼Ÿ

- [KindleGalleryPusherğŸ“·](#kindlegallerypusher)
- [1. ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ã¯ï¼Ÿ](#1-ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ã¯)
- [2. ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã«ã¤ã„ã¦](#2-ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã«ã¤ã„ã¦)
  - [2.1. requirements](#21-requirements)
  - [2.2. thanks for](#22-thanks-for)
  - [2.3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é–¢ã—ã¦](#23-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é–¢ã—ã¦)
    - [2.3.1. mysqlã«é–¢ã—ã¦](#231-mysqlã«é–¢ã—ã¦)
    - [2.3.2. sqlite ã«é–¢ã—ã¦](#232-sqlite-ã«é–¢ã—ã¦)
  - [2.4. kindleé€ä¿¡ã«é–¢ã—ã¦](#24-kindleé€ä¿¡ã«é–¢ã—ã¦)
  - [2.5. hostnameã«é–¢ã—ã¦](#25-hostnameã«é–¢ã—ã¦)
  - [2.6. ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿å®¹é‡ã«é–¢ã—ã¦](#26-ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿å®¹é‡ã«é–¢ã—ã¦)
  - [2.7. nginx + uwsgi ã§ã‚µãƒ¼ãƒ“ã‚¹æä¾›](#27-nginx--uwsgi-ã§ã‚µãƒ¼ãƒ“ã‚¹æä¾›)
- [3. ã‚µã‚¤ãƒˆç®¡ç†](#3-ã‚µã‚¤ãƒˆç®¡ç†)
- [4. ä»Šå¾Œã®äºˆå®š](#4-ä»Šå¾Œã®äºˆå®š)




# 1. ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ã¯ï¼Ÿ
* è‡ªåˆ†ã®å†™çœŸé›†ã‚’kindleã§ã‚‚ã¿ãŸã„äºº
* kindleã‚’ä½¿ã£ã¦ã„ã‚‹å‹é”ã«ã‚·ã‚§ã‚¢ã—ãŸã„äºº


# 2. ã“ã®ã‚µã‚¤ãƒˆã‚¢ãƒ—ãƒªã«ã¤ã„ã¦
* ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸé›†ã‚’è‡ªå‹•ã«*mobi* *epub* ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ã§ãã¾ã™
* æ°—ã«å…¥ã£ãŸå†™çœŸé›†ã‚’ç›´æ¥ã«kindleãƒ‡ãƒã‚¤ã‚¹ã«é€ä¿¡ã§ãã¾ã™

## 2.1. requirements
> * python 3.7
> * Django>2.1
> * awesome-slugify
> * mysqlclient
> * python-cv2
> * Pillow
> * psutil
> * requests
> * beautifulsoup4
> * lxml
> * [django suit-v2 ](https://django-suit.readthedocs.io/en/v2/)
> * django-clean 

## 2.2. thanks for 
> * [KCC](https://github.com/ciromattia/kcc)
 
## 2.3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é–¢ã—ã¦
 
1.  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯*mysql*ã‚’ä½¿ã„ã¾ã™ã€‚*KindleGalleryPusher/settings.py* ã®ã“ã®éƒ¨åˆ†ã‚’ç·¨é›†ã—ã¦ãã ã•ã„
    ```python
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.mysql',
            'NAME': 'kindleGallerysite',
            'USER': 'your_mysql_username',
            'PASSWORD': 'your_mysql_password',
            'HOST': '127.0.0.1',
        }
    }
    ```
2. æ¬¡ã« *mysql shell* ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚Šã¾ã™
    ```sql
    CREATE DATABASE kindleGallerysite
    ```
3. æ¬¡ã«ä¸‹ã®ã‚ˆã†ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã•ã›ã¾ã™
    ```bash
    python manage.py makemigrations account
    python manage.py makemigrations mainsite
    python manage.py makemigrations pushmonitor
    python manage.py migrate
    ```   
4. æœ€å¾Œã«ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™
    ```bash
    python manage.py runserver 127.0.0.1:8000
    ```     
    å®Ÿè¡Œã—ãŸå¾Œã€*127.0.0.1:8000*ã‹ã‚‰ã€ã‚µã‚¤ãƒˆã‚’è¦‹ã‚Œã¾ã™
    
    **è­¦å‘Šï¼**
    
    **python manage.py runserverã€€ã¯ã‚ãã¾ã§ãƒ†ã‚¹ãƒˆã€ãŠã‚ˆã³ *debug* ã®ãŸã‚ã€*django* ã«å†…è”µã•ã‚ŒãŸç°¡å˜ãªweb serverã§ã™ï¼æœ¬ç•ªã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ãŸã„ãªã‚‰ã€*nginx + uwsgi* ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼(ç°¡å˜ã®èª¬æ˜ã¯ä¸‹ã® *nginx + uwsgi* éƒ¨åˆ†ã‚’å‚è€ƒã—ã¦ãã ã•ã„)** 
### 2.3.1. mysqlã«é–¢ã—ã¦

ç¾åœ¨mysqlã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯*8.0*ã§ã™ã€‚*mysql 8.0*ã‹ã‚‰ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æš—å·åŒ–æ–¹æ³•ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

ã—ã‹ã—ã€ç¾åœ¨ã®*django*ã¯ã“ã®æ–°ã—ã„æš—å·åŒ–æ–¹å¼ã‚’æ”¯æ´ã—ã¦ã„ã¾ã›ã‚“ã®ã§ã€ã‚‚ã—*mysql 8.0*ä»¥ä¸Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã†ãªã‚‰ã€æš—å·åŒ–æ–¹å¼ã‚’*Legacy Authentication Method*ã«å¤‰æ›´ã—ã¦ãã ã•ã„

### 2.3.2. sqlite ã«é–¢ã—ã¦

ã‚‚ã—sqliteã‚’ä½¿ã„ãŸã„ãªã‚‰ã€*KindleGalleryPusher/settings.py* ã®*DATABASES*ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ãŸãã ã•ã„

``` python
    DATABASES = {
        'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': 'datas.sql',
        }
    }
```

## 2.4. kindleé€ä¿¡ã«é–¢ã—ã¦

è©³ã—ã„kindleã®é€ä¿¡æ©Ÿèƒ½èª¬æ˜ã¯ã‚¢ãƒã‚¾ãƒ³ã®ãƒšãƒ¼ã‚¸ã‚’ã”è¦§ãã ã•ã„ã€‚

[Kindleãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒ“ã‚¹](https://www.amazon.co.jp/gp/help/customer/display.html/ref=kinw_myk_pd_ln?ie=UTF8&nodeId=200767340#assignemail)

ç°¡å˜ã«è¨€ã†ã¨ã€Kindleã®é€ä¿¡æ©Ÿèƒ½ã¯ã¤ã¾ã‚Š
> é€ä¿¡ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã€eãƒ¡ãƒ¼ãƒ«ã®å½¢ã§kindleãƒ‡ãƒã‚¤ã‚¹ã¨é€£æºã—ã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã«é€ä¿¡ã™ã‚‹ã€‚
> 
> é€ä¿¡å¾Œã€kindleãƒ‡ãƒã‚¤ã‚¹ã¯è‡ªå‹•ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

é€ä¿¡æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€*KindleGalleryPusher/settings.py* ã®smtpã‚’è¨­å®šã—ã¦ãã ã•ã„
```python
EMAIL_HOST = 'smtp.yourserver.net'
EMAIL_HOST_USER = 'your email'
EMAIL_HOST_PASSWORD = 'your_smtp_password'
```

ã¾ãŸã€*pushmonitor/mailsender.py*ã€€ã‚‚åŒã˜ãè¨­å®šã—ã¦ãã ã•ã„

```python
smtp_username = 'your email'
smtp_password = 'your_smtp_password'
smtp_hostname = 'smtp.yourserver.net'
```

## 2.5. hostnameã«é–¢ã—ã¦

*KindleGalleryPusher/settings.py*ã®*ALLOWED_HOSTS* éƒ¨åˆ†ã§ã€è‡ªåˆ†ã®domainã‚’å…¥ã‚Œã¦ãã ã•ã„

```python
ALLOWED_HOSTS = ['gallery.lpanda.net', 'localhost', '127.0.0.1']
```

## 2.6. ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿å®¹é‡ã«é–¢ã—ã¦

ä¸æ­£ãªå¤§é‡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ã‚µãƒ¼ãƒã‚’é«˜è² è·çŠ¶æ…‹ã«ã•ã›ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã€ãƒ‡ãƒ¼ã‚¿å®¹é‡åˆ¶åº¦ã‚’å°å…¥ã—ã¾ã—ãŸã€‚ï¼ˆæºå¸¯ã®ãƒ‡ãƒ¼ã‚¿å®¹é‡ã¨åŒã˜æ„Ÿã˜ï¼‰

* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿å®¹é‡ã¯ *1GB* ã§ã™
* æ¯å›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ™‚ã€ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒå‰Šã‚‰ã‚Œã¾ã™
* ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒ0ã«ãªã£ãŸã‚‰ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒä¸å¯èƒ½ã«ãªã‚Šã¾ã™
* ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ã®å…¨éƒ¨ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã‚‚è¨˜éŒ²ã•ã‚Œã¾ã™
* æ¯æœˆã€ãƒ‡ãƒ¼ã‚¿å®¹é‡ã¯ *1GB* ã«å›å¾©ã—ã¾ã™

ã‚‚ã— *1GB*ã€€ã®ãƒ‡ãƒ¼ã‚¿å®¹é‡ã‚’èª¿æ•´ã—ãŸã„ãªã‚‰ã€ *account/models.py* ã® *USER_BASE_BANDWIDTH*ã€€ã‚’èª¿æ•´ã—ãŸãã ã•ã„


## 2.7. nginx + uwsgi ã§ã‚µãƒ¼ãƒ“ã‚¹æä¾›
1. ã¾ãšã¯*nginx*ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚*debian* ç³»ãªã‚‰
    ```
    apt-get install nginx
    ```
    ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™
2. æ¬¡ã«*uwsgi*ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
    ```
    pip install uwsgi
    ```
3.ã€€æ¬¡ã«*uwsgi* ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ä½œæˆä¾‹ã¯ãƒ•ã‚¡ã‚¤ãƒ« *uwsgi_linux_demon.ini* ã«ã‚ã‚Šã¾ã™ã€‚

```ini
[uwsgi]
socket = 127.0.0.1:8001
chdir = /root/KindleGalleryPusher/
wsgi-file = KindleGalleryPusher/wsgi.py
processes = 4
threads = 2
stats = 127.0.0.1:8002
daemonize = /root/KindleGalleryPusher/log_uwsgi.log
pidfile = /root/KindleGalleryPusher/uwsgi.pid
```
    
4. æœ€å¾Œã«ã‚³ãƒãƒ³ãƒ‰ *uwsgi uwsgi_linux_demon.ini* ã§ã‚¦ã‚§ã‚¤ãƒ–ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™
5. *nging* ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–¹ã¯ãƒ•ã‚¡ã‚¤ãƒ« *nginx_sample.cof*ã€€ã‚’å‚è€ƒã—ã¦ãã ã•ã„ã€‚å„*alias*ã®éƒ¨åˆ†ã‚’æ­£ã—ã„ãƒ‘ã‚¹ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€*server_name* ã‚‚è‡ªåˆ†ã®domainã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
    ```nginx
    upstream django {
        # server unix:///path/to/your/mysite/mysite.sock; # for a file socket
        server 127.0.0.1:3031; # for a web port socket (we'll use this first)
    }

    # configuration of the server
    server {
        # the port your site will be served on
        listen      9000;
        # the domain name it will serve for
        server_name 127.0.0.1; # substitute your machine's IP address or FQDN
        charset     utf-8;

        # max upload size
        client_max_body_size 1000M;   # adjust to taste

        # Django media
        location /media/img  {
            alias /mnt/e/project/KindleGalleryPusher/media/img;  # your Django project's media files - amend as required
        }

        location /static {
            alias /mnt/e/project/KindleGalleryPusher/static; # your Django project's static files - amend as required
        }

        # Finally, send all non-media requests to the Django server.
        location / {
            uwsgi_pass  django;
            include      /etc/nginx/uwsgi_params; # the uwsgi_params file you installed
        }
    location /donwloadbook {
        internal;
        alias /mnt/e/project/KindleGalleryPusher/media;
    }

    }
    ```


# 3. ã‚µã‚¤ãƒˆç®¡ç†
1. ã¾ãšã¯ã‚µã‚¤ãƒˆã®ç®¡ç†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™
    ```bash
    python manage.py createsuperuser
    ```
2. ç®¡ç†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ãŸå¾Œã€ã‚µã‚¤ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™
3. ä¸‹ã®ã‚ˆã†ã«ã‚µã‚¤ãƒˆç®¡ç†ã®ãƒªãƒ³ã‚¯ãŒã§ã¾ã™
   
   ![img1](img/img1.png)
4. ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ã‚µã‚¤ãƒˆã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
   ![img2](img/img2.png)



# 4. ä»Šå¾Œã®äºˆå®š

ç¾åœ¨ä¸€ç•ªå¤§ãã„ãªå•é¡Œã¯ãƒ•ã‚©ãƒãƒ¼ãƒ‰å¤‰æ›ã‚­ãƒ¥ãƒ¼ã¨é€ä¿¡ã‚­ãƒ¥ãƒ¼ã¯ mysql ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
æ™®é€šãªã‚‰ã€ã‚­ãƒ¥ãƒ¼ã¯ *redis* ã§ã‚­ãƒ¥ãƒ¼ã‚’ä½œã‚‹ã®ãŒä¸€ç•ªã‚ˆã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã“ã‚Œã‹ã‚‰ã¯ã‚­ãƒ¥ãƒ¼ã‚’ *redis* ã§ä½œã‚Šã¾ã™ã€‚